<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Nacos集群配置及Nginx反向代理</title>
    <url>/2020/10/27/Nacos%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E5%8F%8ANginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h2 id="安装Nacos"><a href="#安装Nacos" class="headerlink" title="安装Nacos"></a>安装Nacos</h2><p><strong>前提是需要一个虚拟机，本文基于CentOS 7</strong></p>
<ol>
<li><p>下载Nacos</p>
<p> <a href="https://github.com/alibaba/nacos/releases/tag/1.3.2">下载地址</a></p>
</li>
<li><p>配置Nacos</p>
<ul>
<li><p>创建mynacos文件夹；将tar包解压到mynacos文件夹中</p>
</li>
<li><p>配置cluster.conf</p>
  <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> cluster.conf.example cluster.conf</span><br><span class="line">vim cluster.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加以下内容(根据自己的<strong>主机ip</strong>来填</p>
  <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">81.129</span>:<span class="number">3333</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">81.129</span>:<span class="number">4444</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">81.129</span>:<span class="number">4444</span></span><br></pre></td></tr></table></figure>
<a id="more"></a></li>
<li><p>修改数据库文件,<strong>vim application.properties</strong></p>
  <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">spring.datasource.platform=mysql</span><br><span class="line">db.num=<span class="number">1</span></span><br><span class="line">db.url.<span class="number">0</span>=jdbc:mysql://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span>/nacos_config?characterEncoding=utf8&amp;connectTimeout=<span class="number">1000</span>&amp;socketTimeout=<span class="number">3000</span>&amp;autoReconnect=true</span><br><span class="line">db.user=root</span><br><span class="line">db.password=<span class="number">6</span>yhn^YHN</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭防火墙或者开放端口（为了省事，我关闭了和防火墙）</p>
  <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<!-- more -->


<ol start="3">
<li><p>启动Nacos</p>
<p> <strong>TIPS：因为是一台机器，所以以多个实例来设置集群，以端口区分，需要启动三个nacos；如果是多台机器那就正常一个机器起一个nacos即可</strong></p>
<ul>
<li><p>复制<strong>startup.sh</strong></p>
  <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> startup.sh.bak startup<span class="literal">-3333</span>.sh</span><br><span class="line"><span class="built_in">cp</span> startup.sh.bak startup<span class="literal">-4444</span>.sh</span><br><span class="line"><span class="built_in">cp</span> startup.sh.bak startup<span class="literal">-5555</span>.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<strong>vim startup-3333.sh</strong>（一个示例，4444和5555 都按照此修改）,增加-Dserver.port=3333启动时指定端口号</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># start</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$</span>&#123;JAVA_OPT&#125;&quot;</span> &gt; <span class="variable">$</span>&#123;BASE_DIR&#125;/logs/start.out <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">nohup <span class="variable">$JAVA</span> <span class="literal">-Dserver</span>.port=<span class="number">3333</span> <span class="variable">$</span>&#123;JAVA_OPT&#125; nacos.nacos &gt;&gt; <span class="variable">$</span>&#123;BASE_DIR&#125;/logs/start.out <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nacos is starting，you can check the <span class="variable">$</span>&#123;BASE_DIR&#125;/logs/start.out&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动nacos</p>
  <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">./startup<span class="literal">-3333</span>.sh</span><br><span class="line">./startup<span class="literal">-4444</span>.sh</span><br><span class="line">./startup<span class="literal">-5555</span>.sh</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h2><p>贴个安装nginx教程，并且配置stream负载均衡 <a href="http://xiaohost.com/2754.html">转向网址</a></p>
<ol>
<li><p>配置Nginx</p>
<p> 由于我是yum安装的Nginx 配置文件 <strong>vim /etc/nginx/nginx.confg</strong></p>
<ul>
<li><p>设置upstream cluster</p>
</li>
<li><p>设置location根路径。<strong>proxy_pass <a href="http://cluster/">http://cluster</a>;</strong></p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#gzip  on;</span><br><span class="line">upstream cluster&#123;</span><br><span class="line">    server 192.168.81.129:3333;</span><br><span class="line">    server 192.168.81.129:4444;</span><br><span class="line">    server 192.168.81.129:5555;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       1111;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs&#x2F;host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;cluster;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>启动Nginx</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start nginx.service</span><br></pre></td></tr></table></figure></li>
<li><p>登录查看<a href="http://192.168.81.129:1111/nacos/#/login">http://192.168.81.129:1111/nacos/#/login</a></p>
</li>
</ol>
]]></content>
      <tags>
        <tag>Nacos集群</tag>
      </tags>
  </entry>
  <entry>
    <title>my-first-blog</title>
    <url>/2020/10/27/my-first-blog/</url>
    <content><![CDATA[<p>哒哒哒哒哒哒多</p>
]]></content>
  </entry>
  <entry>
    <title>ubuntu 自动挂载SD卡</title>
    <url>/2020/10/27/ubuntu-%E8%87%AA%E5%8A%A8%E6%8C%82%E8%BD%BDSD%E5%8D%A1/</url>
    <content><![CDATA[<p>最近开发过程中遇见了一个问题，ubuntu 16.04 自动挂载SD卡报错，<code>mounted filesystem with ordered data mode. Opts: (null)</code>以此记录一下</p>
<ol>
<li><p>查看分区</p>
 <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line">root@ubuntu16:~<span class="comment"># fdisk -l</span></span><br><span class="line"></span><br><span class="line">中间省略无关东西;主要是为了挂载 /dev/mmcblk0p1</span><br><span class="line"></span><br><span class="line">Disk /dev/mmcblk0: <span class="number">29.7</span> GiB, <span class="number">31914983424</span> bytes, <span class="number">62333952</span> sectors</span><br><span class="line">Units: sectors of <span class="number">1</span> * <span class="number">512</span> = <span class="number">512</span> bytes</span><br><span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: <span class="number">0</span>x00000000</span><br><span class="line"></span><br><span class="line">Device         Boot <span class="built_in">Start</span>      <span class="keyword">End</span>  Sectors  Size Id <span class="built_in">Type</span></span><br><span class="line">/dev/mmcblk0p1       <span class="number">2048</span> <span class="number">62333951</span> <span class="number">62331904</span> <span class="number">29.7</span>G <span class="number">83</span> Linux</span><br><span class="line">root@ubuntu16:~<span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p> sd卡文件格式的原先是fat32位，由于内核是裁剪版，没有fsck.vfat 修复（如果有，可以直接修复），直接将其格式化成ext4 <code>记得备份里面内容</code></p>
<a id="more"></a></li>
<li><p>手动挂载SD卡（ 成功 ）</p>
 <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mount</span> /dev/mmcblk0p1 /mnt/sd/</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><figcaption><span>-h```查看挂载成功</span></figcaption><table><tr><td class="code"><pre><span class="line">&#96;&#96;&#96;powershell</span><br><span class="line">root@ubuntu16:~# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">ubi0:rootfs     437M  384M   54M  88% &#x2F;</span><br><span class="line">devtmpfs        121M     0  121M   0% &#x2F;dev</span><br><span class="line">tmpfs           122M     0  122M   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs           122M  1.7M  120M   2% &#x2F;run</span><br><span class="line">tmpfs           5.0M  4.0K  5.0M   1% &#x2F;run&#x2F;lock</span><br><span class="line">tmpfs           122M     0  122M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mmcblk0p1   30G  153M   28G   1% &#x2F;mnt&#x2F;sd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 手动挂载SD卡可以成功，但是自动挂载却失败了</p>
</li>
</ol>
<h3 id="以下自动挂载过程"><a href="#以下自动挂载过程" class="headerlink" title="以下自动挂载过程"></a>以下自动挂载过程</h3><ol>
<li><p>修改<code>/etc/fstab</code>文件（ 失败 ）</p>
 <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">root@ubuntu16:~<span class="comment"># vim /etc/fstab </span></span><br><span class="line"><span class="comment"># &lt;file system&gt;   &lt;dir&gt;         &lt;type&gt;    &lt;options&gt;                          &lt;dump&gt; &lt;pass&gt;</span></span><br><span class="line">/dev/mmcblk0p2    /             ext4      defaults,noatime,errors=remount<span class="literal">-ro</span>   <span class="number">0</span>      <span class="number">1</span></span><br><span class="line">/dev/mmcblk0p1    /mnt/sd          ext4      defaults                             <span class="number">0</span>      <span class="number">0</span></span><br><span class="line">~                                                                                            </span><br></pre></td></tr></table></figure>

<p> 查看dmesg日志信息，报错如下（裁剪版，连syslog也没有）</p>
 <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="number">24987.953468</span>] EXT4<span class="literal">-fs</span> (mmcblk0p1): mounted filesystem with ordered <span class="keyword">data</span> mode. Opts: (null)</span><br><span class="line">[<span class="number">25051.864722</span>] EXT4<span class="literal">-fs</span> (mmcblk0p1): mounted filesystem with ordered <span class="keyword">data</span> mode. Opts: (null)</span><br><span class="line">[<span class="number">25327.264935</span>] EXT4<span class="literal">-fs</span> (mmcblk0p1): mounted filesystem with ordered <span class="keyword">data</span> mode. Opts: (null)</span><br><span class="line">[<span class="number">25392.234106</span>] EXT4<span class="literal">-fs</span> (mmcblk0p1): mounted filesystem with ordered <span class="keyword">data</span> mode. Opts: (null)</span><br><span class="line">[<span class="number">171378.249554</span>] EXT4<span class="literal">-fs</span> (mmcblk0p1): mounted filesystem with ordered <span class="keyword">data</span> mode. Opts: (null)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>/etc/rc.local</code>文件（ 失败 ）<br> 加入以下内容</p>
 <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mount</span> /dev/mmcblk0p1 /mnt/sd</span><br></pre></td></tr></table></figure>
<p> 重启之后依然报上述错误</p>
</li>
<li><p>手动指定挂在文件类型（ 成功 ）</p>
 <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mount</span> <span class="literal">-t</span> ext4 /dev/mmcblk0p1 /mnt/sd</span><br></pre></td></tr></table></figure>
<p> 重启机器之后，<code>df -h</code>查看挂载成功</p>
</li>
</ol>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol>
<li>文件系统有问题，可以使用<code>fsck.XX</code>参数去修复</li>
<li>期间也尝试了在<code>/etc/fstab</code>使用UUID 来指定，依然报错</li>
<li>手动指定挂在文件类型<code>mount -t ext4 /dev/mmcblk0p1 /mnt/sd</code></li>
</ol>
]]></content>
  </entry>
</search>
